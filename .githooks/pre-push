#!/bin/bash
# pre-push hook: prevent pushing if forbidden
# folders exist or staged .md files

# =====================================================================
# CONFIGURATION
# =====================================================================

FORBIDDEN_FOLDERS=(
#   "palace"
)

# =====================================================================
# CHECK FOR FORBIDDEN FOLDERS
# =====================================================================

echo "=============================================================="
echo "PRE-PUSH CHECK: Forbidden folders and staged .md files"
echo "--------------------------------------------------------------"

FOUND=0

for folder in "${FORBIDDEN_FOLDERS[@]}"; do
    if [ -d "$folder" ]; then
        echo "ERROR: Forbidden folder exists: $folder"
        FOUND=1
    fi
done

# =====================================================================
# CHECK FOR STAGED .MD FILES
# =====================================================================

STAGED_MD=$(git diff --cached --name-only | grep -E '\.md$')
if [ -n "$STAGED_MD" ]; then
    echo "ERROR: Staged Markdown files detected:"
    echo "$STAGED_MD" | sed 's/^/    /'
    FOUND=1
fi
echo "=============================================================="
echo "PRE-PUSH CHECK: Blocking forbidden files"
echo "--------------------------------------------------------------"

# Read refs from stdin (pre-push passes lines: local_ref local_sha remote_ref remote_sha)
while read local_ref local_sha remote_ref remote_sha
do
    # Determine commits being pushed
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, push all commits reachable from local_ref
        RANGE="$local_sha"
    else
        # Existing branch, push only commits not in remote
        RANGE="$remote_sha..$local_sha"
    fi

    # List all files in commits being pushed
    FILES=$(git diff --name-only $RANGE)

    FOUND=0
    for FILE in $FILES; do
        if [[ "$FILE" == ".gitignore" ]]; then
            echo "ERROR: Pushing forbidden file detected: $FILE"
            FOUND=1
        fi
    done

    if [ $FOUND -eq 1 ]; then
        echo "Push aborted. Remove forbidden files before pushing."
        echo "=============================================================="
        exit 1
    fi
done
echo "--------------------------------------------------------------"

if [ $FOUND -eq 1 ]; then
    echo "Push aborted: Fix the issues above before pushing."
    echo "=============================================================="
    exit 1
fi

echo "No forbidden folders or staged .md files found. Push allowed."
echo "=============================================================="
exit 0
